services:
  m87-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: m87-server
    restart: always
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - MONGO_DB=m87-server
      - OAUTH_ISSUER=${OAUTH_ISSUER:-https://auth.make87.com}
      - OAUTH_AUDIENCE=${OAUTH_AUDIENCE:-https://api.make87.com}
      - PUBLIC_ADDRESS=${PUBLIC_ADDRESS:-localhost}
      - FORWARD_SECRET=${FORWARD_SECRET:-dev_secret_change_me}
      - UNIFIED_PORT=${UNIFIED_PORT:-8080}
      - REST_PORT=${REST_PORT:-8081}
      - STAGING=${STAGING:-1}
    depends_on:
      - mongo
    networks:
      - nexus-network
    ports:
      - "443:8080"
      - "8081:8081"
    volumes:
      - backend-data:/app/certs
    profiles:
      - default

  mongo:
    image: mongo:7
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - nexus-network
    profiles:
      - default
      - mongo-only

networks:
  nexus-network:
    driver: bridge

volumes:
  mongo-data:
  backend-data:
